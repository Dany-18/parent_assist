<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Report - Voice Assistant</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    iframe { width: 80%; height: 600px; border: 2px solid #ccc; margin-top: 10px; }
    #chat { margin-top: 20px; text-align: left; width: 80%; margin-left: auto; margin-right: auto; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; background: #f9f9f9; }
    .logo { width: 120px; margin: 10px auto; display: block; }
  </style>
</head>
<body>
  <!-- Logo -->
  <img src="/static/images/logo.png" class="logo" alt="Logo">

  <!-- PDF -->
  <iframe src="{{ pdf_url }}"></iframe>

  <!-- AI Assistant -->
  <h2>üéôÔ∏è AI Voice Assistant</h2>
  <div id="chat"></div>
  <audio id="audio" autoplay hidden></audio>

<script>
function addChat(role, text){
  document.getElementById("chat").innerHTML += "<b>"+role+":</b> "+text+"<br>";
  document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
}

async function ask(q){
  addChat("You", q);
  let res = await fetch("/ask_ai", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({rollno: "{{ rollno }}", question: q, lang: "{{ lang }}"})
  });
  let data = await res.json();
  addChat("AI", data.answer);

  // Speak reply
  document.getElementById("audio").src = "/tts?text=" + encodeURIComponent(data.answer) + "&lang={{ lang }}";
}

// Improved Speech Recognition
function startListening() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = new SpeechRecognition();

  recognition.lang = {
    "ta": "ta-IN",
    "te": "te-IN",
    "ml": "ml-IN",
    "hi": "hi-IN"
  }["{{ lang }}"] || "en-IN";

  recognition.interimResults = false;
  recognition.continuous = false;

  recognition.onresult = function(event) {
    let transcript = event.results[0][0].transcript.trim();
    console.log("Heard:", transcript);
    ask(transcript);
  };

  recognition.onerror = function(event) {
    console.log("Speech error:", event.error);
    setTimeout(startListening, 1500);
  };

  recognition.onend = function() {
    setTimeout(startListening, 1000);
  };

  recognition.start();
}

// Auto Greet after 5 sec
window.onload = function(){
  setTimeout(() => {
    let greet = {
      "ta": "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æâ‡Æ§‡Æµ‡Æø ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Ææ?",
      "te": "‡∞π‡∞≤‡±ã! ‡∞®‡±á‡∞®‡±Å ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ö‡±á‡∞Ø‡∞æ‡∞≤‡∞æ?",
      "ml": "‡¥®‡¥Æ‡¥∏‡µç‡¥ï‡¥æ‡¥∞‡¥Ç! ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ‡¥ï‡µç‡¥ï‡µç ‡¥∏‡¥π‡¥æ‡¥Ø‡¥Ç ‡¥µ‡µá‡¥£‡µã?",
      "hi": "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§ï‡•ã ‡§Æ‡§¶‡§¶ ‡§ö‡§æ‡§π‡§ø‡§è?"
    }["{{ lang }}"] || "Hello! Do you need help?";

    addChat("AI", greet);
    document.getElementById("audio").src = "/tts?text=" + encodeURIComponent(greet) + "&lang={{ lang }}";

    startListening();
  }, 5000);
};
</script>
</body>
</html>






